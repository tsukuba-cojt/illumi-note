# 2025-11-21 API 設計（ドラフト）

元ドキュメント:
- `screen_usecase.md`
- `20251119_action2.md`（画面⇔API対応表）

本書は React（フロント）/ Express（バックエンド）を前提とした JSON ベース REST API のドラフト仕様。★付きは MVP 優先実装。

---

## 1. 前提・共通仕様

### 1.1 ベース
- ベースURL: `/api`
- フォーマット: `application/json; charset=utf-8`
- タイムゾーン: 原則 UTC（クライアント側でローカライズ）

### 1.2 認証・認可
- 認証方式: JWT アクセストークン
  - HTTP ヘッダ: `Authorization: Bearer <accessToken>`
- リフレッシュトークン: HttpOnly Cookie `refreshToken`（案）
- 認証不要エンドポイント:
  - `POST /api/auth/login`
  - `POST /api/auth/register`
  - `POST /api/auth/refresh`（Cookie ベース。Body なし想定）
- それ以外の `/api/**` は原則認証必須。

### 1.3 日付・ID・ステータス
- ID は `string`（UUID など）。
- 日付時刻は ISO 8601 文字列: 例 `2025-11-19T12:34:56Z`。
- プロジェクト状態 `ProjectStatus`（案）:
  - `active` / `archived` / `draft` など（詳細は DB 設計時に確定）。

### 1.4 ページング・並び順
- 共通クエリ（一覧系で利用）:
  - `limit` (number, optional, デフォルト 20, 最大 100)
  - `offset` (number, optional, デフォルト 0)
  - `sort` (string, optional, 例: `updatedAt_desc`, `createdAt_asc`)
- 一覧レスポンスの共通メタ情報:

```json
{
  "data": [
    { "...": "..." }
  ],
  "meta": {
    "total": 123,
    "limit": 20,
    "offset": 0
  }
}
```

### 1.5 エラーレスポンス共通

- ステータスコード例:
  - 400: バリデーションエラー
  - 401: 未認証（トークン無効 or 期限切れ）
  - 403: 権限なし
  - 404: リソース未検出
  - 409: 一意制約違反（メール重複など）
  - 500: サーバーエラー

- ボディ形式（共通案）:

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "email is required",
    "details": {
      "email": ["required"]
    }
  }
}
```

---

## 2. 共通オブジェクト定義（参照用）

※ すべてのフィールドは今後の DB 設計と合わせて変更の可能性あり。

### 2.1 User（ユーザー）

```json
{
  "id": "u_123",
  "displayName": "たべちゃん",
  "email": "user@example.com",
  "avatarUrl": "https://.../avatar.png",
  "notificationPreference": "all",  
  "createdAt": "2025-11-19T12:34:56Z",
  "updatedAt": "2025-11-20T09:00:00Z"
}
```

### 2.2 ProjectSummary（プロジェクト一覧用）

```json
{
  "id": "p_123",
  "name": "舞台A公演2025",
  "status": "active",
  "thumbnailUrl": "https://.../thumb.png",
  "sceneCount": 10,
  "unreadComments": 3,
  "updatedAt": "2025-11-20T09:00:00Z"
}
```

### 2.3 ProjectDetail（プロジェクト詳細）

```json
{
  "id": "p_123",
  "name": "舞台A公演2025",
  "description": "...",
  "status": "active",
  "owner": { "id": "u_1", "displayName": "Owner", "avatarUrl": null },
  "members": [
    { "id": "u_1", "displayName": "Owner", "avatarUrl": null }
  ],
  "currentScene": {
    "id": "s_1",
    "name": "オープニング",
    "timestamp": "00:01:23",
    "thumbnailUrl": "https://.../thumb.png"
  },
  "timecode": "00:01:23",
  "stagePresetId": "stage_1",
  "unityEmbedConfig": {
    "buildUrl": "...",
    "productName": "IllumiNote Stage"
  },
  "notes": "メモテキスト...",
  "createdAt": "2025-11-19T12:34:56Z",
  "updatedAt": "2025-11-20T09:00:00Z"
}
```

### 2.4 SceneSummary（シーン一覧用）

```json
{
  "id": "s_1",
  "projectId": "p_123",
  "name": "オープニング",
  "timestamp": "00:01:23",
  "thumbnailUrl": "https://.../scene.png",
  "lightSummary": "SS: 80, BS: 40 ...",
  "memo": "...",
  "createdAt": "2025-11-19T12:34:56Z",
  "updatedAt": "2025-11-20T09:00:00Z"
}
```

### 2.5 LightState（ライト状態）

`screen_usecase.md` の Project2/3 タブ `lights[]` をベース。

```json
{
  "id": "ls_1",
  "projectId": "p_123",
  "sceneId": "s_1",
  "lights": [
    {
      "id": "SS",
      "label": "サイドスポット",
      "description": "説明テキスト",
      "intensity": 80,
      "color": "#ffffff",
      "enabled": true,
      "infoTooltip": "役割説明..."
    }
  ],
  "createdAt": "2025-11-19T12:34:56Z",
  "updatedAt": "2025-11-20T09:00:00Z"
}
```

### 2.6 StagePreset（ステージプリセット）

```json
{
  "id": "stage_1",
  "name": "Stage 1",
  "thumbnail": "https://.../stage1.png",
  "description": "ステージ形状説明",
  "order": 1
}
```

### 2.7 Comment（コメント）

```json
{
  "id": "c_1",
  "projectId": "p_123",
  "author": {
    "id": "u_1",
    "displayName": "ユーザー名",
    "avatarUrl": null
  },
  "body": "コメント本文",
  "createdAt": "2025-11-19T12:34:56Z",
  "isUnread": true
}
```

### 2.8 Notification（通知）

```json
{
  "id": "n_1",
  "type": "comment",
  "title": "新しいコメント",
  "description": "プロジェクトXにコメントが追加されました",
  "isRead": false,
  "linkedResource": {
    "type": "project",
    "id": "p_123",
    "url": "/projects/p_123"
  },
  "createdAt": "2025-11-19T12:34:56Z"
}
```

### 2.9 Asset（ライブラリアセット）

```json
{
  "id": "a_1",
  "name": "スポットライト素材",
  "category": "light",
  "previewUrl": "https://.../asset.png",
  "tags": ["warm", "spot"],
  "updatedAt": "2025-11-19T12:34:56Z",
  "description": "詳細説明（詳細APIで使用）"
}
```

---

## 3. 認証API

### 3.1 POST /api/auth/register

- **概要**: 新規ユーザー登録（`screen_usecase.md` 新規登録画面）。
- **認証**: 不要
- **リクエストBody**:

```json
{
  "name": "string",
  "email": "string",
  "password": "string",
  "confirmPassword": "string"
}
```

- **バリデーション**:
  - `name`, `email`, `password` 必須
  - パスワード強度チェック
  - `email` 重複チェック（409）
- **レスポンス 201**（案: 自動ログインしてトークン返却）:

```json
{
  "user": { "...": "User" },
  "accessToken": "jwt-access",
  "refreshToken": "jwt-refresh"
}
```

- **エラー**:
  - 400: バリデーションエラー
  - 409: メール重複

### 3.2 POST /api/auth/login ★

- **概要**: email + password でログイン。
- **認証**: 不要
- **リクエストBody**:

```json
{
  "email": "string",
  "password": "string",
  "rememberMe": true
}
```

- **レスポンス 200**:

```json
{
  "user": { "...": "User" },
  "accessToken": "jwt-access",
  "refreshToken": "jwt-refresh"  
}
```

- **備考**:
  - `rememberMe` が true の場合のみ RefreshToken を長期 Cookie で保存（案）。

### 3.3 POST /api/auth/refresh

- **概要**: Refresh Token から Access Token を再発行。
- **認証**: Cookie のみ
- **リクエスト**: Body なし（案）
- **レスポンス 200**:

```json
{
  "accessToken": "jwt-access",
  "refreshToken": "jwt-refresh"
}
```

- **エラー**:
  - 401: refresh token 不正 / 期限切れ

---

## 4. プロジェクトAPI

### 4.1 GET /api/projects ★（一覧）

- **概要**: プロジェクト一覧取得（`screen_usecase` プロジェクト一覧）。
- **認証**: 必須
- **クエリパラメータ**:
  - `search` (string, optional)
  - `status` (string, optional, `active`/`archived` など)
  - `limit`, `offset`, `sort`
- **レスポンス 200**:

```json
{
  "data": [
    { "...": "ProjectSummary" }
  ],
  "meta": {
    "total": 10,
    "limit": 20,
    "offset": 0
  }
}
```

### 4.2 POST /api/projects（作成）

- **概要**: 新規プロジェクト作成（プロジェクト一覧画面の「新規作成」）。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "name": "string",
  "description": "string",
  "stagePresetId": "stage_1"  
}
```

- **レスポンス 201**:

```json
{
  "project": { "...": "ProjectDetail" }
}
```

### 4.3 GET /api/projects/:id ★（詳細）

- **概要**: プロジェクト詳細取得（Project1〜5 タブ共通ヘッダ部分）。
- **認証**: 必須
- **レスポンス 200**:

```json
{
  "project": { "...": "ProjectDetail" }
}
```

### 4.4 PUT /api/projects/:id（更新）

- **概要**: プロジェクト名・説明・メンバー等の更新。
- **認証**: 必須（プロジェクトのオーナー/編集権限のみ）
- **リクエストBody**（一部だけ送信してもよい）:

```json
{
  "name": "string",
  "description": "string",
  "status": "active",
  "memberIds": ["u_1", "u_2"]
}
```

- **レスポンス 200**: 更新後 `project`

### 4.5 DELETE /api/projects/:id（削除/アーカイブ）

- **概要**: プロジェクト削除。実際にはアーカイブフラグ更新（案）。
- **認証**: 必須（オーナーのみ）
- **レスポンス 204**: Body なし

### 4.6 PUT /api/projects/:id/notes（メモ更新）

- **概要**: Project1 概要タブ右下のメモ欄更新。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "notes": "string"
}
```

- **レスポンス 200**:

```json
{
  "projectId": "p_123",
  "notes": "string",
  "updatedBy": { "id": "u_1", "displayName": "..." },
  "updatedAt": "2025-11-20T09:00:00Z"
}
```

### 4.7 PUT /api/projects/:id/stage（ステージ選択保存）

- **概要**: Stage 画面で選択したステージプリセットをプロジェクトに保存。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "stagePresetId": "stage_1"
}
```

- **レスポンス 200**:

```json
{
  "projectId": "p_123",
  "stagePresetId": "stage_1",
  "updatedAt": "2025-11-20T09:00:00Z"
}
```

---

## 5. シーン & ライトAPI

### 5.1 POST /api/light-states ★（ライト状態保存）

- **概要**: Unity から送信されるライト状態を保存。単体保存用（シーン保存とまとめて行う場合は `/api/scenes` 参照）。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "projectId": "p_123",
  "sceneId": "s_1",  
  "lights": [
    {
      "id": "SS",
      "label": "サイドスポット",
      "description": "...",
      "intensity": 80,
      "color": "#ffffff",
      "enabled": true
    }
  ]
}
```

- **レスポンス 201**:

```json
{
  "lightState": { "...": "LightState" }
}
```

### 5.2 GET /api/light-states ★（ライト状態取得）

- **概要**: シーンに紐づくライト状態の取得。
- **認証**: 必須
- **クエリパラメータ**:
  - `sceneId` (必須)
- **レスポンス 200**:

```json
{
  "lightState": { "...": "LightState" }
}
```

### 5.3 GET /api/lights/meta（ライトメタ情報）

- **概要**: Project2/3 タブで使うライト名称・説明・ツールチップ。
- **認証**: 必須
- **レスポンス 200**:

```json
{
  "lights": [
    {
      "id": "SS",
      "label": "サイドスポット",
      "description": "...",
      "infoTooltip": "役割説明...",
      "defaultIntensity": 80,
      "defaultColor": "#ffffff",
      "order": 1
    }
  ]
}
```

### 5.4 GET /api/scenes ★（シーン一覧取得）

- **概要**: Project4 タブ用のシーン一覧。
- **認証**: 必須
- **クエリパラメータ**:
  - `projectId` (必須)
  - `limit`, `offset`, `sort`（例: `timestamp_desc`）
- **レスポンス 200**:

```json
{
  "data": [
    { "...": "SceneSummary" }
  ],
  "meta": {
    "total": 10,
    "limit": 20,
    "offset": 0
  }
}
```

### 5.5 POST /api/scenes ★（シーン保存）

- **概要**: 現在のライト状態を含めて新規シーンとして保存。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "projectId": "p_123",
  "name": "オープニング",
  "memo": "string",
  "timestamp": "00:01:23",  
  "lightState": {      
    "lights": [
      {
        "id": "SS",
        "intensity": 80,
        "color": "#ffffff",
        "enabled": true
      }
    ]
  }
}
```

- **レスポンス 201**:

```json
{
  "scene": { "...": "SceneSummary" },
  "lightState": { "...": "LightState" }
}
```

### 5.6 PUT /api/scenes/:id（シーン更新）

- **概要**: シーン名・メモなどの更新。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "name": "string",
  "memo": "string"
}
```

- **レスポンス 200**: 更新後 `scene`

### 5.7 POST /api/scenes/:id/export（シーンエクスポート）

- **概要**: シーンを CSV / 画像としてエクスポートし、ダウンロード URL を返す。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "exportType": "csv"  
}
```

- **レスポンス 202 例**（非同期ジョブ前提の案）:

```json
{
  "jobId": "job_1",
  "status": "queued"
}
```

- **あるいは同期 200 例**:

```json
{
  "downloadUrl": "https://.../export.csv",
  "metadata": {
    "sceneId": "s_1",
    "exportType": "csv"
  }
}
```

---

## 6. 共有 & コメントAPI

### 6.1 GET /api/projects/:id/share-link（共有リンク取得）

- **概要**: Project5 共有タブで既存共有リンク表示。
- **認証**: 必須（プロジェクトメンバー）
- **レスポンス 200**:

```json
{
  "projectId": "p_123",
  "shareLink": "https://app/.../share/p_123_token",
  "expiresAt": null
}
```

### 6.2 POST /api/projects/:id/share（メール招待）

- **概要**: プロジェクト共有メール送信。
- **認証**: 必須（メンバー招待権限）
- **リクエストBody**:

```json
{
  "inviteEmail": "member@example.com",
  "accessLevel": "editor"  
}
```

- **レスポンス 200**:

```json
{
  "projectId": "p_123",
  "inviteEmail": "member@example.com",
  "accessLevel": "editor"
}
```

### 6.3 GET /api/projects/:id/comments（コメント一覧）

- **概要**: コメントタブ用一覧。ページング必須。
- **認証**: 必須
- **クエリパラメータ**:
  - `limit`, `offset`
- **レスポンス 200**:

```json
{
  "data": [
    { "...": "Comment" }
  ],
  "meta": {
    "total": 30,
    "limit": 20,
    "offset": 0
  }
}
```

### 6.4 POST /api/projects/:id/comments（コメント投稿）

- **概要**: コメント投稿。成功後通知を作成（サーバー内処理）。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "body": "コメント本文"
}
```

- **レスポンス 201**:

```json
{
  "comment": { "...": "Comment" }
}
```

---

## 7. 通知API

### 7.1 GET /api/notifications（通知一覧）

- **概要**: 通知画面およびヘッダの未読件数バッジ用。
- **認証**: 必須
- **クエリパラメータ**:
  - `isRead` (optional, `true`/`false`)
  - `limit`, `offset`
- **レスポンス 200**:

```json
{
  "data": [
    { "...": "Notification" }
  ],
  "meta": {
    "total": 5,
    "limit": 20,
    "offset": 0
  }
}
```

### 7.2 POST /api/notifications/read（既読更新）

- **概要**: 指定 ID 群を既読にする。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "ids": ["n_1", "n_2"]
}
```

- **レスポンス 200**:

```json
{
  "updatedCount": 2
}
```

---

## 8. ステージAPI

### 8.1 GET /api/stages/presets（ステージプリセット一覧）

- **概要**: Stage 画面の Stage1〜4 などのプリセット一覧。
- **認証**: 必須
- **レスポンス 200**:

```json
{
  "presets": [
    { "...": "StagePreset" }
  ]
}
```

---

## 9. ライブラリAPI

### 9.1 GET /api/assets（アセット一覧）

- **概要**: ライブラリ画面の一覧。カテゴリ/タグフィルタ対応。
- **認証**: 必須
- **クエリパラメータ**:
  - `category` (optional)
  - `tags` (optional, カンマ区切り)
  - `search` (optional)
  - `limit`, `offset`
- **レスポンス 200**:

```json
{
  "data": [
    { "...": "Asset" }
  ],
  "meta": {
    "total": 10,
    "limit": 20,
    "offset": 0
  }
}
```

### 9.2 GET /api/assets/:id（アセット詳細）

- **概要**: 詳細モーダル用詳細情報。
- **認証**: 必須
- **レスポンス 200**:

```json
{
  "asset": {
    "...": "Asset",
    "metadata": {
      "size": "1.2MB",
      "resolution": "1920x1080"
    }
  }
}
```

---

## 10. ユーザープロフィールAPI

### 10.1 GET /api/users/me（自分のプロフィール取得）

- **概要**: プロフィール画面の初期値用。
- **認証**: 必須
- **レスポンス 200**:

```json
{
  "user": { "...": "User" }
}
```

### 10.2 PUT /api/users/me（プロフィール更新）

- **概要**: 表示名・通知設定などの更新。
- **認証**: 必須
- **リクエストBody**:

```json
{
  "displayName": "string",
  "notificationPreference": "all"  
}
```

- **レスポンス 200**:

```json
{
  "user": { "...": "User" }
}
```

### 10.3 POST /api/users/me/avatar（アバターアップロード）

- **概要**: アバター画像アップロード。
- **認証**: 必須
- **コンテンツタイプ**: `multipart/form-data`
- **リクエストフィールド**:
  - `file`: 画像ファイル（png/jpg）
- **レスポンス 200**:

```json
{
  "avatarUrl": "https://.../avatar.png"
}
```

---

## 11. 優先API一覧（Action2 対応）

- 認証系 ★: `POST /api/auth/login`, `POST /api/auth/register`, `POST /api/auth/refresh`
- プロジェクト一覧 ★: `GET /api/projects`, `POST /api/projects`
- プロジェクト詳細 ★: `GET /api/projects/:id`
- シーン & ライト ★:
  - `POST /api/scenes`
  - `GET /api/scenes?projectId=`
  - `POST /api/light-states`
  - `GET /api/light-states?sceneId=`
- その他（MVP外だが Action2 に記載）も本書に全て定義済み。
