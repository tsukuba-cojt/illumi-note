# 2025-11-19 Action 3 — 優先API仕様ドラフト

screen_usecase.md と Action2マッピングから、優先度の高い3エンドポイント（ログイン、プロジェクト一覧、シーン保存）を詳細化した。

## 1. POST /api/auth/login
- **目的**: email+passwordで認証し、アクセストークンとユーザー情報を返す。
- **URL / Method**: `POST /api/auth/login`
- **認証**: 不要（公開エンドポイント）。
- **リクエストBody**
  ```json
  {
    "email": "user@example.com",
    "password": "Passw0rd!"
  }
  ```
- **レスポンス 200**
  ```json
  {
    "user": {
      "id": "u_123",
      "name": "照明太郎",
      "role": "member"
    },
    "token": {
      "accessToken": "<JWT>",
      "expiresIn": 3600,
      "refreshToken": "<JWT_REFRESH>"
    }
  }
  ```
- **エラー**
  - 400: バリデーション失敗（メール形式など）。
  - 401: 認証失敗（メール/パスワード不一致）。
  - 429: 過剰リクエスト（ブルートフォース対策）。
- **備考**
  - Refresh TokenはHttpOnly Cookie or DBに保存し、`/api/auth/refresh` で更新。
  - 成功時にフロントはアクセストークンをメモリ/LocalStorage、ユーザー情報をグローバル状態に保持。

## 2. GET /api/projects
- **目的**: ログインユーザーが閲覧可能なプロジェクトの一覧を取得し、ホーム画面のカード表示に使用。
- **URL / Method**: `GET /api/projects`
- **認証**: 必須（Bearer JWT）。
- **クエリパラメータ**
  - `search` (optional): プロジェクト名の部分一致。
  - `status` (optional): active/archived。
  - `limit` (optional, default=20), `offset` (optional, default=0)。
- **レスポンス 200**
  ```json
  {
    "items": [
      {
        "id": "p_001",
        "name": "秋公演A案",
        "updatedAt": "2025-11-18T09:00:00Z",
        "thumbnailUrl": "/storage/projects/p_001/thumb.png",
        "sceneCount": 5,
        "unreadComments": 2,
        "owner": {
          "id": "u_owner",
          "name": "演出 花子"
        }
      }
    ],
    "total": 12
  }
  ```
- **エラー**
  - 401: 未認証。
  - 403: 権限不足（ロール制御がある場合）。
  - 500: DBエラー。
- **備考**
  - `thumbnailUrl` が無い場合はプレースホルダーURLを返す。
  - 今後ステージ進捗や通知数を追加する場合は `extra` オブジェクトに拡張。

## 3. POST /api/scenes
- **目的**: Stage画面で作成したライト状態をシーンとして保存し、プロジェクト4タブの一覧やUnityとの再ロードで利用。
- **URL / Method**: `POST /api/scenes`
- **認証**: 必須（Bearer JWT）。
- **リクエストBody**
  ```json
  {
    "projectId": "p_001",
    "stagePresetId": "stage1",
    "name": "Scene 1 - Intro",
    "timecode": "00:00",
    "lightState": [
      {
        "lightId": "L1",
        "label": "SS",
        "intensity": 0.8,
        "color": "#FFD966",
        "pan": 30,
        "tilt": 15,
        "enabled": true
      }
    ],
    "notes": "フェードイン開始30秒前",
    "snapshotUrl": "https://storage/.../scene1.png"
  }
  ```
- **レスポンス 201**
  ```json
  {
    "id": "s_123",
    "projectId": "p_001",
    "version": 1,
    "createdAt": "2025-11-19T05:00:00Z",
    "updatedAt": "2025-11-19T05:00:00Z"
  }
  ```
- **エラー**
  - 400: `projectId` や `lightState` 欠落、JSON形式不正。
  - 404: プロジェクト存在しない、またはアクセス権無し。
  - 409: 同名シーンが既に存在（任意仕様）。
  - 500: Unityから受け取ったスナップショット保存失敗など。
- **備考**
  - `lightState` の構造はたべちゃん（Unity/DB）と合意したJSONフォーマットを採用。必要であれば `color` をRGB/HSVで分離。
  - 保存に成功したら Unity へ postMessage で "sceneSaved" を返し、React側でもトースト表示。
  - 将来のバージョン管理のため `version` と `parentSceneId` を追加可能。
